var fs = require('fs'),
    exec = require('child_process').exec, child;

function encode(secret, image_file, callback){
  child = exec('convert '+image_file+' '+image_file+'.bmp', function(){
    image_file = image_file+'.bmp';
    fs.readFile(secret, function(err, secret_data){
      if(err) throw err;
        fs.readFile(image_file, function(err, data){
          if(err) throw err;
          var offset = Math.floor(data.length/secret_data.length);
          for(var i=0; i< secret_data.length; i++){
            secret_data.copy(data, (i+1)*offset, i, i+1);
          }
          var d = new Date();
          var file_name = d.getTime()+'_'+offset+'.bmp';
          var output = './public/images/'+file_name;
          fs.writeFile(output, data, function(err){
            if(err) throw err;
            if(typeof(callback) === 'function'){
              callback(offset, file_name);
            }
          });
        });
    });
  });
}

function decode(offset, stego_path, callback){
  fs.readFile(stego_path, function(err, data){
    if(err) throw err;
    secret_len = Math.floor(data.length/offset);
    message = new Buffer(secret_len);
    for(i=0; i<=secret_len; i++){
      extract = data[(i+1)*offset];
      message[i] = extract;
    }
    var d = new Date();
    var file_name = 'decode_'+d.getTime();
    fs.writeFile('./public/data/'+file_name, message, function(err){
      if(err) throw err;
      if(typeof(callback) === 'function'){
        callback(file_name, secret_len);
      }
    });
  });
}

exports.decode = decode;
exports.encode = encode;
